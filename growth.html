<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Analysis - CVEDB</title>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="static/images/logo.png">

    <!-- Stylesheet -->
    <link rel="stylesheet" href="static/css/style.css">

    <!-- Meta tags for SEO -->
    <meta name="description"
        content="CVEDB provides comprehensive analysis and visualization of Common Vulnerabilities and Exposures (CVE) data from 1999 to present.">
    <meta name="keywords" content="CVE, vulnerabilities, security, analysis, dashboard, cybersecurity">
    <meta name="author" content="CVEDB">

    <!-- Open Graph tags -->
    <meta property="og:title" content="CVEDB - CVE Analysis Dashboard">
    <meta property="og:description"
        content="Comprehensive CVE analysis and visualization from 1999 to present">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://cvedb.github.io">
    <meta property="og:image" content="https://cvedb.github.io/static/images/logo.png">
</head>

<body>
    <!-- Header and Navigation -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="static/images/logo.png" alt="CVEDB Logo">
                CVEDB
            </a>

            <nav class="nav">
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="years.html">Yearly Analysis</a></li>
                    <li><a href="cna.html">CNA</a></li>
                    <li><a href="cpe.html">CPE</a></li>
                    <li><a href="cwe.html">CWE</a></li>
                    <li><a href="cvss.html">CVSS</a></li>
                    <li><a href="growth.html">Growth</a></li>
                    <li><a href="calendar.html">Calendar</a></li>
                </ul>
                <button class="nav-toggle" aria-label="Toggle navigation">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.chart-container {
    position: relative;
    width: 100%;
}

/* Active button styling for better visual indication */
.quick-select-btn.active {
    background-color: #3b82f6 !important;
    color: white !important;
    border-color: #2563eb !important;
}

.quick-select-btn:hover {
    background-color: #60a5fa;
    color: white;
    border-color: #3b82f6;
}
</style>

<!-- Hero Section -->
<div class="page-header mb-4 text-center">
    <h1 class="display-4 mb-2">Growth Intelligence Dashboard</h1>
    <small class="text-muted d-block mb-3" id="pageSubtitle">
        Showing comprehensive growth analysis across all years (1999-2025)
    </small>
    
    <!-- Note about historical data requirement -->
    <div class="d-flex justify-content-center mb-3">
        <div class="text-muted small">
            <i class="fas fa-info-circle me-1"></i>
            Growth analysis shows comprehensive trends across all years (1999-2025)
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid mb-4">
    <div class="stat-card">
        <div class="stat-number" id="totalCvesCount">-</div>
        <div class="stat-label">Total CVEs</div>
        <small class="text-muted" style="font-size: 0.75rem;" id="totalCvesSubtext">üìä Loading...</small>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="avgGrowthRate">-</div>
        <div class="stat-label">Average Annual Growth</div>
        <small class="text-muted" style="font-size: 0.75rem;" id="avgGrowthSubtext">üìà Loading...</small>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="peakGrowthYear">-</div>
        <div class="stat-label">Peak Growth Year</div>
        <small class="text-muted" style="font-size: 0.75rem;" id="peakGrowthSubtext">üöÄ Loading...</small>
    </div>
    
    <div class="stat-card">
        <div class="stat-number" id="ytdComparison">-</div>
        <div class="stat-label">Year-to-Date Growth</div>
        <small class="text-muted" style="font-size: 0.75rem;" id="ytdSubtext">üìÖ Loading...</small>
    </div>
</div>

<!-- Charts Section -->
<div class="row g-4 mb-4">
    <!-- CVE Growth Trends Chart -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
                <h3 class="card-title mb-0" style="font-size: 1.1rem;">
                    <i class="fas fa-chart-line me-2"></i>CVE Growth Trends Over Time
                </h3>
                <div class="chart-controls">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary active quick-select-btn" id="absoluteBtn" onclick="toggleGrowthView('absolute')">
                            <i class="fas fa-chart-bar me-1"></i>Absolute
                        </button>
                        <button type="button" class="btn btn-outline-secondary quick-select-btn" id="rateBtn" onclick="toggleGrowthView('rate')">
                            <i class="fas fa-percentage me-1"></i>Growth Rate
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="growthTrendsChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Growth Rate Distribution Chart -->
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header py-2">
                <h3 class="card-title mb-0" style="font-size: 1.1rem;">
                    <i class="fas fa-chart-bar me-2"></i>Growth Rate Distribution
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 400px;">
                    <canvas id="growthDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cumulative Growth Chart -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header py-2">
                <h3 class="card-title mb-0" style="font-size: 1.1rem;">
                    <i class="fas fa-chart-area me-2"></i>Cumulative CVE Growth
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="cumulativeGrowthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Growth Insights Panel -->
<div class="card mb-4">
    <div class="card-header py-2">
        <h3 class="card-title" style="font-size: 1.1rem;">üîç Growth Intelligence Insights</h3>
    </div>
    <div class="card-body py-3">
        <div class="row" id="growthInsights">
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üìà</div>
                    <div class="insight-content">
                        <div class="insight-title">Highest Growth</div>
                        <div class="insight-text" id="highestGrowthInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üìâ</div>
                    <div class="insight-content">
                        <div class="insight-title">Lowest Growth</div>
                        <div class="insight-text" id="lowestGrowthInsight">Loading...</div>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="insight-card">
                    <div class="insight-icon">üìä</div>
                    <div class="insight-content">
                        <div class="insight-title">Trend Analysis</div>
                        <div class="insight-text" id="trendAnalysisInsight">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Growth Data Table -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header py-2">
                <h3 class="card-title mb-0" style="font-size: 1.1rem;">
                    <i class="fas fa-table me-2"></i>Year-over-Year Growth Data
                </h3>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Total CVEs</th>
                                <th>Growth Rate</th>
                                <th>Absolute Change</th>
                                <th>3-Year Avg</th>
                            </tr>
                        </thead>
                        <tbody id="growthTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading growth data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export and Share Panel -->
<div class="card mb-3">
    <div class="card-header py-2">
        <h2 class="card-title mb-0" style="font-size: 1.1rem;">üì§ Export & Share</h2>
    </div>
    <div class="card-body py-3">
        <div class="export-buttons">
            <button class="btn btn-primary btn-sm" onclick="exportData('csv')">üìä Export CSV</button>
            <button class="btn btn-primary btn-sm" onclick="exportData('json')">üìã Export JSON</button>
            <button class="btn btn-secondary btn-sm" onclick="copyPermalink()">üîó Copy Permalink</button>
            <button class="btn btn-secondary btn-sm" onclick="window.print()">üñ®Ô∏è Print Report</button>
        </div>
        <div class="permalink-result mt-2" id="permalinkResult" style="display: none;">
            <input type="text" class="form-control" id="permalinkInput" readonly>
            <button class="btn btn-outline-primary btn-sm mt-1" onclick="copyPermalink()">Copy Link</button>
        </div>
    </div>
</div>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div style="display: flex; flex-wrap: wrap; gap: 2rem; justify-content: space-between;">
                <div style="flex: 1; min-width: 200px;">
                    <p class="mb-1"><strong>Data Sources:</strong></p>
                    <p class="text-muted small mb-0">
                        <a href="https://nvd.nist.gov/" target="_blank" class="text-decoration-none">National
                            Vulnerability Database (NVD)</a><br>
                        <a href="https://cve.org/" target="_blank" class="text-decoration-none">CVE Program</a><br>
                        Last updated: <span id="lastUpdated">Loading...</span>
                    </p>
                </div>
                <div style="flex: 1; min-width: 200px; text-align: right;">
                    <p class="mb-1"><strong>Platform Links:</strong></p>
                    <p class="text-muted small mb-0">
                        <a href="about.html" class="text-decoration-none">About CVEDB</a><br>
                        <a href="https://cvedb.github.io" target="_blank" class="text-decoration-none">CNA
                            Scorecard</a><br>
                        <a href="https://cvedb.github.io" target="_blank" class="text-decoration-none">CVE
                            Forecast</a><br>
                        <a href="https://github.com/cvedbs/cvedb.github.io" target="_blank"
                            class="text-decoration-none">GitHub Repository</a>
                    </p>
                </div>
            </div>
            <hr class="my-2">
            <div class="text-center">
                <small class="text-muted">
                    &copy; 2025 CVEDB ‚Ä¢ Built by <a
                        href="https://cvedb.github.io" target="_blank" class="text-decoration-none">CVEDB</a><br>
                    Data updated every 6 hours ‚Ä¢ CVE coverage: 1999-2025
                </small>
            </div>
        </div>
    </footer>

    <!-- Chart.js Library (UMD version) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- D3.js for advanced visualizations -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Universal timestamp loader -->
    <script>
        // Universal function to load and display the last updated timestamp
        // Uses cve_all.json as the single source of truth for all pages
        function loadUniversalTimestamp() {
            const lastUpdatedElement = document.getElementById('lastUpdated');
            if (!lastUpdatedElement) return;

            fetch('data/cve_all.json?v=' + new Date().getTime())
                .then(response => response.json())
                .then(data => {
                    if (data.generated_at) {
                        const date = new Date(data.generated_at);
                        const options = {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false, // Use 24-hour clock
                            timeZone: 'UTC', // Always show UTC
                            timeZoneName: 'short'
                        };
                        const formattedDate = date.toLocaleString('en-US', options);
                        lastUpdatedElement.textContent = formattedDate;
                    } else {
                        lastUpdatedElement.textContent = 'Unknown';
                    }
                })
                .catch(error => {
                    console.error('Error loading timestamp:', error);
                    lastUpdatedElement.textContent = 'Error loading timestamp';
                });
        }

        // Load timestamp when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            loadUniversalTimestamp();
        });
    </script>

    <!-- Custom JavaScript -->
    <script>
        // Wait for Chart.js to load before configuring
        document.addEventListener('DOMContentLoaded', function () {
            if (typeof Chart !== 'undefined') {
                // Global configuration for Chart.js with design system
                Chart.defaults.responsive = true;
                Chart.defaults.maintainAspectRatio = false;
                Chart.defaults.plugins.legend.position = 'top';
                Chart.defaults.plugins.legend.labels.usePointStyle = true;
                Chart.defaults.plugins.legend.labels.padding = 20;
                Chart.defaults.plugins.legend.labels.font = {
                    family: 'Inter, sans-serif',
                    size: 12,
                    weight: '500'
                };
                Chart.defaults.plugins.title.display = true;
                Chart.defaults.plugins.title.font = {
                    family: 'Inter, sans-serif',
                    size: 16,
                    weight: '600'
                };
                Chart.defaults.plugins.title.color = '#212529';
                Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
                Chart.defaults.plugins.tooltip.titleColor = '#212529';
                Chart.defaults.plugins.tooltip.bodyColor = '#6c757d';
                Chart.defaults.plugins.tooltip.borderColor = '#dee2e6';
                Chart.defaults.plugins.tooltip.borderWidth = 1;
                Chart.defaults.plugins.tooltip.cornerRadius = 8;
                Chart.defaults.plugins.tooltip.titleFont = {
                    family: 'Inter, sans-serif',
                    size: 13,
                    weight: '600'
                };
                Chart.defaults.plugins.tooltip.bodyFont = {
                    family: 'Inter, sans-serif',
                    size: 12,
                    weight: '400'
                };
                // Chart.js v4 scale configuration
                Chart.defaults.elements.point.backgroundColor = '#2196f3';
                Chart.defaults.elements.point.borderColor = '#2196f3';
                Chart.defaults.elements.line.borderColor = '#2196f3';
                Chart.defaults.elements.bar.backgroundColor = '#2196f3';

                // Note: Scale-specific defaults are set per chart type in Chart.js v4
                // Global scale defaults are handled differently
            }

            // Add active class to current page navigation link
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const navLinks = document.querySelectorAll('.nav-menu a');

            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href === currentPage || (currentPage === '' && href === 'index.html')) {
                    link.classList.add('active');
                }
            });
        });

        // Enhanced Color palette for consistent styling (Light Blue to Grey)
        window.CVE_COLORS = window.CVE_COLORS || {
            primary: '#2196f3',
            secondary: '#64b5f6',
            success: '#81c784',
            warning: '#ffb74d',
            danger: '#f06292',
            light: '#f8f9fa',
            dark: '#212529',

            // Light Blue to Grey Visualization Palette
            vizColors: [
                '#e3f2fd', // Very light blue
                '#bbdefb', // Light blue
                '#90caf9', // Medium light blue
                '#64b5f6', // Medium blue
                '#42a5f5', // Blue
                '#2196f3', // Primary blue
                '#1e88e5', // Darker blue
                '#1976d2', // Dark blue
                '#9e9e9e', // Medium grey
                '#757575'  // Dark grey
            ],

            // Chart-specific colors
            chartColors: [
                '#2196f3', // Primary blue
                '#64b5f6', // Secondary blue
                '#90caf9', // Tertiary blue
                '#bbdefb', // Quaternary blue
                '#81c784', // Accent green
                '#ffb74d', // Accent orange
                '#f06292', // Accent pink
                '#e0e0e0', // Light grey
                '#9e9e9e', // Medium grey
                '#616161'  // Dark grey
            ],

            // Gradient colors for backgrounds
            gradients: {
                primary: 'linear-gradient(135deg, #e3f2fd, #bbdefb)',
                secondary: 'linear-gradient(135deg, #bbdefb, #90caf9)',
                tertiary: 'linear-gradient(135deg, #90caf9, #64b5f6)'
            }
        };

        // Enhanced utility function to generate colors for charts
        function getChartColors(count, type = 'chart') {
            const colors = [];
            const palette = type === 'viz' ? CVE_COLORS.vizColors : CVE_COLORS.chartColors;

            for (let i = 0; i < count; i++) {
                colors.push(palette[i % palette.length]);
            }
            return colors;
        }

        // Generate light blue to grey gradient colors
        function getGradientColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                const ratio = i / Math.max(count - 1, 1);
                // Interpolate between light blue and grey
                const r = Math.round(227 + (158 - 227) * ratio); // e3 to 9e
                const g = Math.round(242 + (158 - 242) * ratio); // f2 to 9e
                const b = Math.round(253 + (158 - 253) * ratio); // fd to 9e
                colors.push(`rgb(${r}, ${g}, ${b})`);
            }
            return colors;
        }

        // Get color with opacity
        function getColorWithOpacity(color, opacity = 0.8) {
            if (color.startsWith('#')) {
                const r = parseInt(color.slice(1, 3), 16);
                const g = parseInt(color.slice(3, 5), 16);
                const b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${opacity})`;
            }
            return color;
        }

        // Utility function to format numbers
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        // Utility function to show loading state
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading data...</div>';
            }
        }

        // Utility function to hide loading state
        function hideLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                const loading = container.querySelector('.loading');
                if (loading) {
                    loading.remove();
                }
            }
        }

        // Get current year for dynamic functionality
        const CURRENT_YEAR = new Date().getFullYear();
        const AVAILABLE_YEARS = [];
        for (let year = 1999; year <= CURRENT_YEAR; year++) {
            AVAILABLE_YEARS.push(year);
        }
    </script>

    
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
<script>
// Global variables
let currentGrowthView = 'absolute';
let growthData = null;
let charts = {};

// Light blue/gray color palette
const colorPalette = {
    primary: '#60a5fa',      // Light blue
    secondary: '#93c5fd',    // Lighter blue
    tertiary: '#bfdbfe',     // Very light blue
    accent: '#3b82f6',       // Standard blue
    gray: '#9ca3af',         // Light gray
    lightGray: '#d1d5db',    // Very light gray
    success: '#10b981',      // Green
    warning: '#f59e0b',      // Orange
    danger: '#ef4444',       // Red
    info: '#06b6d4'          // Cyan
};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadGrowthData();
});

// Load growth data
function loadGrowthData() {
    fetch('/data/growth_analysis.json')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            growthData = data;
            updateStatsCards(data);
            updateGrowthTrendsChart(data);
            updateGrowthDistributionChart(data);
            updateCumulativeGrowthChart(data);
            updateGrowthInsights(data);
            updateGrowthTable(data);
        })
        .catch(error => {
            console.error('Error loading growth data:', error);
            showErrorState();
        });
}

// Update stats cards
function updateStatsCards(data) {
    const growthDataArray = data.growth_data || [];
    
    if (growthDataArray.length === 0) {
        document.getElementById('totalCvesCount').textContent = '0';
        document.getElementById('avgGrowthRate').textContent = '0%';
        document.getElementById('peakGrowthYear').textContent = '-';
        document.getElementById('ytdComparison').textContent = '0%';
        return;
    }
    
    // Total CVEs (latest year)
    const latestYear = growthDataArray[growthDataArray.length - 1];
    document.getElementById('totalCvesCount').textContent = latestYear.cves.toLocaleString();
    document.getElementById('totalCvesSubtext').textContent = `As of ${latestYear.year}`;
    
    // Average annual growth
    const avgGrowth = data.avg_annual_growth || 0;
    document.getElementById('avgGrowthRate').textContent = `${avgGrowth}%`;
    document.getElementById('avgGrowthSubtext').textContent = `Across ${growthDataArray.length} years`;
    
    // Peak growth year
    const peakGrowth = data.highest_growth_year;
    if (peakGrowth) {
        document.getElementById('peakGrowthYear').textContent = peakGrowth.year;
        document.getElementById('peakGrowthSubtext').textContent = `${peakGrowth.growth_rate}% growth`;
    }
    
    // Year-to-date comparison - use same data source as table (growth_data array)
    const ytdGrowthDataArray = data.growth_data || [];
    const currentYearData = ytdGrowthDataArray.find(d => d.is_ytd === true);
    
    if (currentYearData && typeof currentYearData.ytd_vs_prev_ytd === 'number') {
        const ytdGrowth = currentYearData.ytd_vs_prev_ytd;
        const currentYearCVEs = currentYearData.cves;
        const prevYearYTDEstimate = currentYearData.prev_year_ytd_estimate || 0;
        
        document.getElementById('ytdComparison').textContent = `${ytdGrowth > 0 ? '+' : ''}${ytdGrowth}%`;
        document.getElementById('ytdSubtext').innerHTML = `${currentYearCVEs.toLocaleString()} vs ${prevYearYTDEstimate.toLocaleString()} CVEs<br>(YTD vs Same Period Last Year)`;
    } else {
        console.log('YTD validation failed:', { 
            hasData: !!currentYearData, 
            hasYTDField: currentYearData ? 'ytd_vs_prev_ytd' in currentYearData : false,
            ytdValue: currentYearData ? currentYearData.ytd_vs_prev_ytd : 'N/A'
        });
        document.getElementById('ytdComparison').textContent = 'N/A';
        document.getElementById('ytdSubtext').textContent = 'Insufficient data';
    }
}

// Update growth trends chart
function updateGrowthTrendsChart(data) {
    const ctx = document.getElementById('growthTrendsChart').getContext('2d');
    
    // Destroy existing chart
    if (charts.growthTrends) {
        charts.growthTrends.destroy();
    }
    
    const growthDataArray = data.growth_data || [];
    // Filter out current year YTD data for trend analysis since it's not comparable to completed years
    const completedYearsData = growthDataArray.filter(d => !d.is_ytd);
    const labels = completedYearsData.map(d => d.year);
    
    let chartData, yAxisLabel, yAxisConfig;
    
    if (currentGrowthView === 'absolute') {
        chartData = completedYearsData.map(d => d.cves);
        yAxisLabel = 'Total CVEs';
        yAxisConfig = {
            beginAtZero: true,
            ticks: {
                callback: function(value) {
                    return value.toLocaleString();
                }
            }
        };
    } else {
        chartData = completedYearsData.map(d => d.growth_rate);
        yAxisLabel = 'Growth Rate (%)';
        yAxisConfig = {
            ticks: {
                callback: function(value) {
                    return value + '%';
                }
            }
        };
    }
    
    charts.growthTrends = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: yAxisLabel,
                data: chartData,
                borderColor: colorPalette.primary,
                backgroundColor: `${colorPalette.primary}20`,
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: colorPalette.primary,
                pointBorderColor: '#ffffff',
                pointBorderWidth: 2,
                pointRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Year ${context[0].label}`;
                        },
                        label: function(context) {
                            if (currentGrowthView === 'absolute') {
                                return `Total CVEs: ${context.parsed.y.toLocaleString()}`;
                            } else {
                                return `Growth Rate: ${context.parsed.y}%`;
                            }
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: yAxisLabel
                    },
                    ...yAxisConfig
                }
            }
        }
    });
}

// Update growth distribution chart
function updateGrowthDistributionChart(data) {
    const ctx = document.getElementById('growthDistributionChart').getContext('2d');
    
    // Destroy existing chart
    if (charts.growthDistribution) {
        charts.growthDistribution.destroy();
    }
    
    const growthDataArray = data.growth_data || [];
    // Skip first year (0% growth) and exclude current year YTD data
    const growthRates = growthDataArray.slice(1)
        .filter(d => !d.is_ytd) // Exclude YTD data from distribution
        .map(d => d.growth_rate);
    
    // Create growth rate bins (ordered from highest to lowest, negative at bottom)
    const bins = {
        '50%+': growthRates.filter(r => r >= 50).length,
        '25-50%': growthRates.filter(r => r >= 25 && r < 50).length,
        '10-25%': growthRates.filter(r => r >= 10 && r < 25).length,
        '0-10%': growthRates.filter(r => r >= 0 && r < 10).length,
        'Negative': growthRates.filter(r => r < 0).length
    };
    
    charts.growthDistribution = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(bins),
            datasets: [{
                label: 'Years',
                data: Object.values(bins),
                backgroundColor: [
                    colorPalette.accent,     // Darkest blue for 50%+ (highest growth)
                    colorPalette.primary,    // Light blue for 25-50%
                    colorPalette.secondary,  // Lighter blue for 10-25%
                    colorPalette.tertiary,   // Very light blue for 0-10%
                    colorPalette.lightGray   // Light gray for negative (lowest)
                ],
                borderColor: [
                    colorPalette.accent,
                    colorPalette.primary,
                    colorPalette.secondary,
                    colorPalette.tertiary,
                    colorPalette.gray
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y', // This makes it a horizontal bar chart
            plugins: {
                legend: {
                    display: false // Hide legend for cleaner look
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                            return `${context.parsed.x} years (${percentage}%)`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Years'
                    },
                    grid: {
                        color: colorPalette.lightGray
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Growth Rate Range'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
}

// Update cumulative growth chart
function updateCumulativeGrowthChart(data) {
    const ctx = document.getElementById('cumulativeGrowthChart').getContext('2d');
    
    // Destroy existing chart
    if (charts.cumulativeGrowth) {
        charts.cumulativeGrowth.destroy();
    }
    
    const growthDataArray = data.growth_data || [];
    // Filter out current year YTD data for consistency with other charts
    const completedYearsData = growthDataArray.filter(d => !d.is_ytd);
    const labels = completedYearsData.map(d => d.year);
    const cumulativeData = completedYearsData.map(d => d.cves);
    
    charts.cumulativeGrowth = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Cumulative CVEs',
                data: cumulativeData,
                backgroundColor: `${colorPalette.primary}CC`,
                borderColor: colorPalette.accent,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Year ${context[0].label}`;
                        },
                        label: function(context) {
                            return `Total CVEs: ${context.parsed.y.toLocaleString()}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Year'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Cumulative CVEs'
                    },
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Update growth insights
function updateGrowthInsights(data) {
    const highestGrowth = data.highest_growth_year;
    const lowestGrowth = data.lowest_growth_year;
    const avgGrowth = data.avg_annual_growth || 0;
    
    // Highest growth insight
    if (highestGrowth) {
        document.getElementById('highestGrowthInsight').innerHTML = 
            `<strong>${highestGrowth.year}</strong> saw the highest growth at <strong>${highestGrowth.growth_rate}%</strong> with ${highestGrowth.growth_absolute.toLocaleString()} new CVEs.`;
    }
    
    // Lowest growth insight
    if (lowestGrowth) {
        document.getElementById('lowestGrowthInsight').innerHTML = 
            `<strong>${lowestGrowth.year}</strong> had the lowest growth at <strong>${lowestGrowth.growth_rate}%</strong> with ${lowestGrowth.growth_absolute.toLocaleString()} new CVEs.`;
    }
    
    // Trend analysis
    const growthDataArray = data.growth_data || [];
    if (growthDataArray.length >= 5) {
        const recentYears = growthDataArray.slice(-5);
        const recentAvg = recentYears.reduce((sum, year) => sum + year.growth_rate, 0) / recentYears.length;
        const trend = recentAvg > avgGrowth ? 'accelerating' : 'decelerating';
        
        document.getElementById('trendAnalysisInsight').innerHTML = 
            `Recent 5-year average growth is <strong>${recentAvg.toFixed(1)}%</strong>, indicating <strong>${trend}</strong> growth trends.`;
    }
}

// Update growth table
function updateGrowthTable(data) {
    const tableBody = document.getElementById('growthTableBody');
    const growthDataArray = data.growth_data || [];
    
    if (growthDataArray.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No growth data available</td></tr>';
        return;
    }
    
    tableBody.innerHTML = growthDataArray.map(yearData => {
        const growthRateClass = yearData.growth_rate > 0 ? 'text-success' : yearData.growth_rate < 0 ? 'text-danger' : 'text-muted';
        const growthIcon = yearData.growth_rate > 0 ? '‚ÜóÔ∏è' : yearData.growth_rate < 0 ? '‚ÜòÔ∏è' : '‚û°Ô∏è';
        
        let rowClass = '';
        let yearDisplay = yearData.year;
        let borderLeftStyle = '';
        
        if (yearData.is_ytd) {
            rowClass = 'table-warning';
            borderLeftStyle = '4px solid #ffc107';
            yearDisplay = `${yearData.year} <span class="badge bg-warning text-dark ms-1">YTD</span>`;
        }
        
        const growthIconHtml = yearData.growth_rate > 0 ? 
            '<i class="fas fa-arrow-up text-success me-1"></i>' : 
            '<i class="fas fa-arrow-down text-danger me-1"></i>';
        
        return `
            <tr class="${rowClass}" style="border-left: ${borderLeftStyle}">
                <td>${yearDisplay}</td>
                <td>${yearData.cves.toLocaleString()}</td>
                <td class="${growthRateClass}">
                    ${growthIconHtml}${yearData.growth_rate > 0 ? '+' : ''}${yearData.growth_rate}%
                </td>
                <td class="${yearData.growth_absolute >= 0 ? 'text-success' : 'text-danger'}">
                    ${yearData.growth_absolute >= 0 ? '+' : ''}${yearData.growth_absolute.toLocaleString()}
                </td>
                <td>${yearData.growth_rate_3yr_avg}%</td>
            </tr>
        `;
    }).join('');
}

// Growth view toggle (absolute vs rate)
function toggleGrowthView(view) {
    if (currentGrowthView === view) return;
    
    currentGrowthView = view;
    
    // Update button states
    document.getElementById('absoluteBtn').classList.toggle('active', view === 'absolute');
    document.getElementById('rateBtn').classList.toggle('active', view === 'rate');
    
    // Update chart
    if (growthData) {
        updateGrowthTrendsChart(growthData);
    }
}



// Sort table
function sortTable(column) {
    if (!growthData || !growthData.growth_data) return;
    
    const sortedData = [...growthData.growth_data];
    
    sortedData.sort((a, b) => {
        if (column === 'year') {
            return b.year - a.year; // Descending by year
        } else if (column === 'growth_rate') {
            return b.growth_rate - a.growth_rate; // Descending by growth rate
        }
        return 0;
    });
    
    // Update table with sorted data
    const tempData = { ...growthData, growth_data: sortedData };
    updateGrowthTable(tempData);
}

// Export data
function exportData(format) {
    if (!growthData) {
        alert('No data available to export');
        return;
    }
    
    const filename = `growth_analysis_${currentDataMode}_${new Date().toISOString().split('T')[0]}`;
    
    if (format === 'csv') {
        const csv = convertToCSV(growthData.growth_data);
        downloadFile(csv, `${filename}.csv`, 'text/csv');
    } else if (format === 'json') {
        const json = JSON.stringify(growthData, null, 2);
        downloadFile(json, `${filename}.json`, 'application/json');
    }
}

// Convert data to CSV
function convertToCSV(data) {
    if (!data || data.length === 0) return '';
    
    const headers = ['Year', 'Total CVEs', 'Growth Rate (%)', 'Absolute Change', '3-Year Average (%)'];
    const csvContent = [
        headers.join(','),
        ...data.map(row => [
            row.year,
            row.cves,
            row.growth_rate,
            row.growth_absolute,
            row.growth_rate_3yr_avg
        ].join(','))
    ].join('\n');
    
    return csvContent;
}

// Download file
function downloadFile(content, filename, contentType) {
    const blob = new Blob([content], { type: contentType });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Timestamp now handled by universal loader in base.html

// Copy permalink
function copyPermalink() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy permalink:', err);
        alert('Failed to copy permalink to clipboard');
    });
}

// Show error state
function showErrorState() {
    document.getElementById('totalCvesCount').textContent = 'Error';
    document.getElementById('avgGrowthRate').textContent = 'Error';
    document.getElementById('peakGrowthYear').textContent = 'Error';
    document.getElementById('ytdComparison').textContent = 'Error';
    
    document.getElementById('totalCvesSubtext').textContent = 'Failed to load data';
    document.getElementById('avgGrowthSubtext').textContent = 'Failed to load data';
    document.getElementById('peakGrowthSubtext').textContent = 'Failed to load data';
    document.getElementById('ytdSubtext').textContent = 'Failed to load data';
    
    document.getElementById('growthTableBody').innerHTML = 
        '<tr><td colspan="5" class="text-center text-danger">Error loading growth data</td></tr>';
}
</script>

</body>

</html>